#!/bin/sh
echo "\033[1;32mLoading xbps-src configuration..."
CFG=
if [ -f "$1" ]; then
	CFG="$1"
elif [ -f "/etc/xbps/xbps-src.conf" ]; then
	CFG="/etc/xbps/xbps-src.conf"
elif [ -f "/usr/local/etc/xbps/xbps-src.conf" ]; then
	CFG="/usr/local/etc/xbps/xbps-src.conf"
else
	echo "ERROR: You need to have xbps-src installed."
	echo "Get it from https://github.com/xtraeme/xbps-src"
	exit 1;
fi
. $CFG
SRCPKGS=$XBPS_DISTDIR/srcpkgs

echo "\033[1;32mGetting list of updates, please wait..."
if [ -f "repo-checkvers.txt" ]; then
	echo "\033[1;32m(using cache; rm 'repo-checkvers.txt' to recheck)..."
else
	xbps-src -c $CFG repo-checkvers | grep pkgname | tee repo-checkvers.txt
fi
cat repo-checkvers.txt | awk '{ print $2 }' > pkgs.txt

echo "\033[1;32mCreating source targets..."
rm -rf tobuild built
mkdir -p tobuild built
for p in `cat pkgs.txt`; do
	touch tobuild/$p
done

_TOBUILD="`find tobuild -type f`"
TOBUILD=

concat() {
	local found=0
	for tb in $TOBUILD; do
		if [ "$1" = "$tb" ]; then
			found=1
			break
		fi
	done
	if [ $found -eq 0 ]; then
		TOBUILD="$TOBUILD $1"
	fi
}

getlink() {
	local p="`basename $1`"
	local target="`readlink $SRCPKGS/$p`"
	if [ $? -eq 0 -a -n "$target" ]; then
		p=$target
	fi
	echo $p
}

echo "\033[1;32mGenerating a proper list (without subpkgs)..."
for tb in $_TOBUILD; do
		concat "`getlink $tb`"
done

echo "\033[1;32mRemoving old Makefile (if any)..."
rm -f Makefile
touch Makefile

echo "\033[1;32mGenerating standard targets..."
echo "# Generated by configure, do not modify.\n"		>> Makefile
echo "PKGS := $TOBUILD"						>> Makefile
echo "TOBUILD := \$(patsubst %,tobuild/%,\$(PKGS))"		>> Makefile
echo "BUILT := \$(patsubst tobuild/%,built/%,\$(TOBUILD))\n"	>> Makefile
echo "all: \$(BUILT)"						>> Makefile
echo "\t@echo \"\033[1;32m[Done]\"\n"				>> Makefile
echo "print_pkgs:"						>> Makefile
echo "\t@echo \$(PKGS)\n"					>> Makefile
echo "built/%: tobuild/%"					>> Makefile
echo "\t@echo \"\033[1;32m[xbps-src]\t\${@F}\""			>> Makefile
echo "\t@xbps-src -c $CFG build-pkg \${@F}"			>> Makefile
echo "\t@touch \$@"						>> Makefile
echo "\t@rm tobuild/\${@F}\n"					>> Makefile

echo "\033[1;32mFinding and adding dependencies..."
echo "# Dependencies"						>> Makefile
for p in $TOBUILD; do
	sedcmd="s|[<>].*\$||g"
	_deps="`xbps-src -c $CFG show-deps $p build | sed -e \"$sedcmd\"`"
	deps=
	for d in $_deps; do
		found=0
		realdep=`getlink $d`
		for _p in $TOBUILD; do
			if [ "$_p" = "$realdep" ]; then
				found=1
				break;
			fi
		done
		if [ $found -gt 0 ]; then
			deps="$deps built/$realdep"
		fi
	done
	echo "built/$p: $deps\n"				>> Makefile
done

echo "clean:"							>> Makefile
echo "\t@rm -f built/*"						>> Makefile
echo "\t@echo \"[Clean]\"\n"					>> Makefile
echo ".PHONY: all print_pkgs clean"				>> Makefile

echo "\033[1;32m'Makefile' generated.\033[m"
